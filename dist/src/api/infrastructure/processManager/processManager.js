import{spawn}from"child_process";import*as fs from"fs";import fetch from"node-fetch";import{UploadPixeldrainService}from"../../application/services/uploader.pixeldrain.service.js";import{UploadJsonBlobService}from"../../application/services/uploader.jsonblob.service.js";import{PATH_STREAMS_OUTPUT,COOKIE_PATH}from"../../../../root_path.js";import{v4 as uuidv4}from"uuid";import{config}from"../../application/config/index.js";import{container}from"tsyringe";import{LiveService}from"../../application/services/lives.service.js";import{StreamersService}from"../../application/services/streamers.service.js";import{ThumbnailService}from"../../application/services/thumbnail.service.js";export class LivesManager{proxies;constructor(){}RequestCentralProcess=new Map;OnlineCentralProcess=new Map;LiveService=container.resolve(LiveService);StreamersService=container.resolve(StreamersService);ALIAS_PROXY_CHAT={};MILLISECONDS_DALAY_MAP=5e3;ONLINE_CHECK_TIME=3e4;_thumbnailService=new ThumbnailService;_uploadPixeldrainService=new UploadPixeldrainService;_uploadJsonBlobService=new UploadJsonBlobService;EXTENSION_DEFAULT=config.processManager.EXTENSION_VIDEO_DEFAULT;MAX_TIME_LIVE=config.processManager.MAX_TIME_LIVE;ONLINE_STATUS=config.processManager.TIKTOK_ONLINE_STATUS||2;isVerifyingStreamers=!1;list_of_proxies_free=[];intervalId;async initializeStreamers(){}async addProcess(e){Array.from(this.RequestCentralProcess.values()).some((t=>t.streamer===e.streamer&&t.platform===e.platform))||(e.id=await uuidv4(),await this.RequestCentralProcess.set(e.id,e),this.RequestCentralProcess.size>0&&!this.isVerifyingStreamers&&(this.isVerifyingStreamers=!0,await this.verifyIfStreamersIsOnline(),this.isVerifyingStreamers=!1))}async startProcessLiveSave(e){await this.createDiretoryStream(e.id);e.streamer;let t={id:e.id,live_id:e.live_id,streamer:e.streamer,platform:e.platform,country:String(e.country)};const s=await this.getTitle(`https://tiktok.com/@${e.streamer}/live`);s.length&&(e.tittle=s,t.title=s);const r=["-y","-loglevel","quiet","-i",String(e.urlM3U8),...this.MAX_TIME_LIVE?["-t",this.MAX_TIME_LIVE]:[],"-c","copy","-f","mp4",`file:${PATH_STREAMS_OUTPUT}${e.id}/${e.id}${this.EXTENSION_DEFAULT}.part`],i=["-y","-loglevel","quiet","-i",`file:${PATH_STREAMS_OUTPUT}${e.id}/${e.id}${this.EXTENSION_DEFAULT}.part`,"-map","0","-dn","-ignore_unknown","-c","copy","-f","mp4","-bsf:a","aac_adtstoasc","-movflags","+faststart",`file:${PATH_STREAMS_OUTPUT}${e.id}/${e.id}${this.EXTENSION_DEFAULT}`],a=spawn("ffmpeg",r),o=await this.getCategorie(String(t.title),String(e.urlM3U8),t.streamer),n=await this.LiveService.saveLives({streamer:e.streamer,platform:e.platform,tittle:t.title,tags:o,country:t.country});e.live_id=n,t.live_id=n;const c={status:"awaiting",streamer:String(e.streamer),platform:"tiktok",urlM3U8:String(e.urlM3U8),process:a,id:e.id};await this.OnlineCentralProcess.set(e.id,c),a.on("error",(e=>{})),a.on("close",(async(s,r)=>{if(0===s){e.process=null,await this.OnlineCentralProcess.delete(e.id),await this.addProcess(e);const s=spawn("ffmpeg",i);s.on("error",(e=>{})),s.on("close",(async(s,r)=>{if(0===s)try{await this._thumbnailService.createThumbnail(`${PATH_STREAMS_OUTPUT}${t.id}/${t.id}.mp4`,`${PATH_STREAMS_OUTPUT}${t.id}/${t.id}.jpg`,String(t.live_id)),await this._uploadPixeldrainService.uploadStream(t.id,e.streamer,e.platform,String(t.live_id))}catch(e){}
//!this.OnlineCentralProcess.delete(_process.id)
else try{await this.OnlineCentralProcess.delete(e.id),e.process=null,await this.addProcess(e)}catch(e){}}))}else{spawn("ffmpeg",i).on("close",(async(t,s)=>{0===t?(e.process=null,await this.OnlineCentralProcess.delete(e.id),await this.addProcess(e)):(await this.OnlineCentralProcess.delete(e.id),e.process=null,await this.addProcess(e))})),await this.RequestCentralProcess.delete(e.id),await void 0}}))}createDiretoryStream=async e=>{fs.mkdir(PATH_STREAMS_OUTPUT+e,{recursive:!0},(e=>{}))};getCategorie=async(e,t,s)=>{if(!e||!s)return[];const r=e.toLowerCase(),i=s.toLowerCase(),a={chatting:{keywords:["conversando","chat","talking","conversa","chatting"]},dance:{keywords:["dançando","dança","dancing","dance"]},games:{keywords:["jogando","gameplay","game","gaming","jogo"]},asmr:{keywords:["asmr","sussurro","relaxing","sons"]},music:{keywords:["música","music","cantando","singing","karaoke"]},cooking:{keywords:["cozinhando","cooking","receita","culinária"]}},o=[];for(const[e,s]of Object.entries(a)){s.keywords.some((e=>r.includes(e.toLowerCase())||t.includes(e.toLowerCase())||i.includes(e.toLowerCase())))&&o.push(e)}return o};async addNumberToExistingUUID(e){const t=/-?(\d+)$/,s=e.match(t);if(s){const r=parseInt(s[1],10)+1;return e.replace(t,`-${r}`)}return`${e}-1`}async getStatusStreamerInHtml(e){let t={status:0,urls:{}};return e.match(/"status":\s*0/)&&(t.status=2),t}async getStatusStreamerInHtml_OLD(e){return e.match(/"status":\s*2/)?2:0}async getStatusStreamer(e){let t={status:!1,urls:{}};const s=new Headers({Origin:"tiktok.com","Referrer-Policy":"strict-origin-when-cross-origin","User-Agent":"Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Mobile Safari/537.36"});try{const r=await fetch(`https://tiktok.com/@${e}`,{headers:s});if(200===r.status){const e=await this.getStatusStreamerInHtml(await r.text());e.status,e.status==this.ONLINE_STATUS&&(t.status=!0,t.urls=e.urls)}}catch(e){}return t}async getStatusStreamerDLP(e){return new Promise(((t,s)=>{const r={status:!1,urls:""},i=spawn("yt-dlp",["--cookies",COOKIE_PATH,"--get-url",`https://tiktok.com/@${e}/live`]);let a="",o="";i.stdout.on("data",(e=>{a+=e.toString(),a.includes("http")&&(r.status=!0,r.urls=a.trim(),t(r))})),i.stderr.on("data",(e=>{o+=e.toString()})),i.on("close",(e=>{0!==e?o.includes("The channel is not currently live")?t(r):s(new Error(`Processo encerrado com código ${e}: ${o.trim()}`)):r.status||t(r)})),i.on("error",(e=>{s(new Error(`Erro ao executar yt-dlp: ${e.message}`))}))}))}async verifyIfStreamersIsOnline(){this.intervalId||(this.intervalId=setInterval((async()=>{if(!(this.RequestCentralProcess.size<1))for(const e of this.RequestCentralProcess){const t=await this.getStatusStreamerDLP(e[1].streamer);t.status&&(e[1].urlM3U8=t.urls,await this.RequestCentralProcess.delete(e[0]),"true"!=config.MAINTENANCE_MODE&&await this.startProcessLiveSave(e[1]))}}),this.ONLINE_CHECK_TIME))}getHls=async e=>new Promise(((t,s)=>{const r=spawn("yt-dlp",["-q","-f","hls-hd/flv-hd/hls-hd_60/flv-hd_60/hls-sd/flv-sd/hls-ld/flv-ld/best","--get-url",e]);let i="";r?.stdout.on("data",(e=>{i+=e.toString()})),r.on("close",(e=>{t(i.trim())}))}));getTitle=async e=>new Promise(((t,s)=>{const r=spawn("yt-dlp",["--get-title",e]);let i="";r?.stdout.on("data",(e=>{i+=e.toString().replace(/\d{4}-\d{2}-\d{2}( \d{2}:\d{2})?/g,"").trim()})),r.on("close",(e=>{t(i.trim())}))}));async listProcesso(){this.OnlineCentralProcess.forEach((e=>{}))}async listOffineProcesso(){this.RequestCentralProcess.forEach((e=>{}))}async clearProcess(){this.RequestCentralProcess.forEach((async e=>{e.process.on("close",(async t=>{0===t&&(await this.RequestCentralProcess.delete(e.id),this.RequestCentralProcess)}))})),await this.listProcesso()}async checkChildProcessesStatus(){this.OnlineCentralProcess.forEach((async(e,t)=>{e.process.killed&&await this.RequestCentralProcess.delete(e.id)}))}async setStreamers(){this.addProcess({status:"running",streamer:"kahjs0",platform:"tiktok",process:null,country:"br",id:""}),this.addProcess({status:"running",streamer:"laura_sonaro",platform:"tiktok",process:null,country:"br",id:""})}async onShutdown(){const e=[...Array.from(this.RequestCentralProcess.values()).map((e=>e.streamer)),...Array.from(this.OnlineCentralProcess.values()).map((e=>e.streamer))];await this.StreamersService.returnStreamersToDatabase(e),await this.LiveService.deleteLivesWithoutUrl(e);process.exit(0)}async preparationForShutdown(){process.on("SIGINT",this.onShutdown),process.on("SIGTERM",this.onShutdown),process.on("uncaughtException",(e=>{this.onShutdown()}))}}export const processLiveManager=new LivesManager;processLiveManager.preparationForShutdown().then;