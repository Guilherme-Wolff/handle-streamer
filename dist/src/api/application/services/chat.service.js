import*as fs from"node:fs";import fsPrimisse from"fs/promises";import{ProxyAgent}from"proxy-agent";import{WebcastPushConnection}from"tiktok-live-connector";import{PATH_RESPONSE_UPLOADS,PATH_STREAMS_OUTPUT}from"../../../../root_path.js";export class TiktokChat{stream_id="";streamer="";json_name="";path_name="";vodStartTime=Date.now();chatHistory=[];proxy={};intervalId;current_proxy;chatHistoryInterval=null;constructor(t,e,s,i,n){this.stream_id=t,this.streamer=e,this.json_name=i,this.current_proxy=n,this.path_name=s}tiktokLiveConnection;async initializeConnection(t){try{const t=`http://${this.current_proxy.host}:${this.current_proxy.port}`,e=new ProxyAgent(t);this.tiktokLiveConnection=new WebcastPushConnection(this.streamer,{requestOptions:{httpsAgent:e,timeout:1e4},websocketOptions:{httpsAgent:e,timeout:1e4}}),this.vodStartTime=Date.now();await this.tiktokLiveConnection.connect();this.setupEventHandlers(this.chatHistory),this.ensureJSONFileExists(),await this.saveChatInterval()}catch(t){}}async saveChatInterval(){this.chatHistoryInterval||(this.chatHistoryInterval=setInterval((async()=>{this.saveChatHistoryAccumulate_2(this.chatHistory)}),1e4))}clearChatHistoryInterval(){this.chatHistoryInterval&&(clearInterval(this.chatHistoryInterval),this.chatHistoryInterval=null)}stopChatHistorySaving(){this.chatHistoryInterval&&(clearInterval(this.chatHistoryInterval),this.chatHistoryInterval=null)}async disconnect(){this.tiktokLiveConnection&&(this.stopChatHistorySaving(),this.tiktokLiveConnection.removeAllListeners(),this.tiktokLiveConnection.disconnect(),this.tiktokLiveConnection=null)}async setupEventHandlers(t){this.tiktokLiveConnection&&(this.tiktokLiveConnection.on("chat",(t=>{const e=Date.now()-this.vodStartTime,s={type:"chat",messageId:t.uniqueId,timestamp:e,user:{userId:t.userId,username:t.userId,userRole:""},message:{text:t.comment}};this.chatHistory.push(s)})),this.tiktokLiveConnection.on("gift",(t=>{1===t.giftType&&t.repeatEnd;const e=Date.now()-this.vodStartTime,s={type:"gift",messageId:t.uniqueId,timestamp:e,user:{userId:t.userId,username:t.userId,userRole:""},message:{giftId:t.giftId,giftName:t.giftName}};this.chatHistory.push(s)})),this.tiktokLiveConnection.on("disconnected",(t=>{this.tiktokLiveConnection&&this.tiktokLiveConnection.disconnect()})))}async saveChatHistoryAcumulate(t){const e=`${PATH_STREAMS_OUTPUT}${this.path_name}/${this.json_name}`;try{let s={};try{const t=await fsPrimisse.readFile(e,"utf8");s=JSON.parse(t)}catch(t){t.code}for(const[e,i]of Object.entries(t))s[e]||(s[e]=[]),Array.isArray(i)&&s[e].push(...i);await fsPrimisse.writeFile(e,JSON.stringify(s,null,2),"utf-8")}catch(t){}}async ensureJSONFileExists(){const t=`${PATH_STREAMS_OUTPUT}${this.path_name}/${this.json_name}`;if(!fs.existsSync(t)){const e={metadata:{liveStart:new Date(this.vodStartTime).toISOString()},chatLog:[]};fs.writeFileSync(t,JSON.stringify(e,null,4),"utf-8")}}async saveChatHistoryAccumulate_2(t){const e=`${PATH_STREAMS_OUTPUT}${this.path_name}/${this.json_name}`;try{let s;const i=await fsPrimisse.readFile(e,"utf8");s=JSON.parse(i),s.chatLog.push(t),await fsPrimisse.writeFile(e,JSON.stringify(s,null,2),"utf8"),this.chatHistory=[]}catch(t){}}saveChatHistory(t){fs.writeFile(PATH_RESPONSE_UPLOADS+this.json_name,JSON.stringify(t,null,2),(t=>{}))}async loadChatJson(t){try{const e=await fsPrimisse.readFile(t,"utf8");return JSON.parse(e)}catch(t){}}async addChatMessage(t,e){t.chat.push(e),t.metadata.totalMessages+=1,t.metadata.updatedAt=(new Date).toISOString()}async saveJSONToFile(t,e){fs.writeFileSync(t,JSON.stringify(e,null,2),"utf-8")}}