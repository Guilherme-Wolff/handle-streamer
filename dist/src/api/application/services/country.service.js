import*as fs from"fs/promises";import*as fs_sync from"node:fs";import*as cheerio from"cheerio";import{HTML_USERS_PATH}from"../../../../root_path.js";import{spawn}from"child_process";export class CountryService{constructor(){}async getCountry(t,e="tiktok"){const r=`https://www.tiktok.com/@${t}`;let a={exist:!1,country:""};try{const e=t+".html",o=spawn("curl",["-X","GET",r],{stdio:["inherit","pipe","pipe"]}),s=fs_sync.createWriteStream(HTML_USERS_PATH+e);o.stdout.pipe(s),await new Promise(((t,e)=>{o.on("close",(r=>{0===r?t():e(new Error(`Failed to fetch HTML. Exit code: ${r}`))}))}));const c=await this.readFileHTML(t),i=await this.extractCountry(c);return a.exist=!0,a.country=i,await this.deleteFile(HTML_USERS_PATH+e),await a}catch(t){throw new Error(t.message)}}async extractCountry(t,e="tiktok"){const r=(await cheerio.load(t))("body").text().match(/"userInfo"\s*:\s*({(?:[^{}]|{(?:[^{}]|{[^{}]*})*})*})/);if(!r||!r[1])return null;try{let t=r[1].replace(/\\u002F/g,"/").replace(/\n/g,"").replace(/\\"/g,'"').replace(/,\s*}/g,"}").replace(/,\s*]/g,"]"),e=(t.match(/{/g)||[]).length,a=(t.match(/}/g)||[]).length;for(;e>a;)t+="}",a++;const o=JSON.parse(t).user.region;return o.toLowerCase()}catch(t){return null}}async fix_url(t){const e=await t.replace(/\\u002F/g,"/");return await e}async readFileHTML(t){try{const e=HTML_USERS_PATH+t+".html";return await fs.readFile(e,"utf8")}catch(t){throw new Error(t.message)}}async deleteFile(t){try{await fs.unlink(t)}catch(t){return}}}